<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta description="SIMpliCode is the fastest, easiest way to sample your code online, with a built-in AI editor and instant preview">
    <meta name="viewport" content="width=device-width, initial-scale=1.2, shrink-to-fit=no">
    <title>SIMpliCode</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

    <link rel="stylesheet" href="style.css">

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script> 
    <!-- CodeMirror for live syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <!-- DOMPurify for AI output -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  </head>
  <body> 
    <div class="main-container">
      <!-- Toggle button (fixed at top-right) -->


      <!-- Toggle button (fixed at top-right) -->
      <button id="sidebarToggle"><strong>&lt;ยง&gt;</strong></button>

      <!-- Pop-out sidebar -->
      <aside id="sidebar">
        <div class="sidebar-header">
          <span>Options</span>
        </div>
        <div class="sidebar-content">

          <span style="float: right;">General</span>

          <button id="settings-button" title="Open SIMpliCode settings"><img src="https://img.icons8.com/?size=100&id=2969&format=png" class="sidebar-img"><span>Settings</span></button>

          <button id="help-button" title="How to use SIMpliCode"><img src="https://img.icons8.com/ios-filled/help" class="sidebar-img"><span>Help</span></button><br><br>

          <span style="float: right;">Chat</span>

          <a href=''><button id="clear-chat" title="Reload the page and clear the chat"><img src="https://img.icons8.com/?size=100&id=35635&format=png" class="sidebar-img"><span>Reload Page</span></button></a>


          <button id="download"  onclick="downloadChat()" title="Download the chat as an .rtf file"><img src="https://img.icons8.com/?size=100&id=18764&format=png" class="sidebar-img"> <span>Save Chat</span></button>

          <button id="import-chat" title="Import a chat from file"><img src="https://img.icons8.com/?size=100&id=8301&format=png" class="sidebar-img"> <span>Import Chat</span></button><br><br>

          <span style="float: right;">Code</span>
          <button id="save" onclick="openPopup()" title="Download the HTML"><img src="https://img.icons8.com/?size=100&id=2945&format=png" class="sidebar-img"> <span>Download Code</span></button>

          <button id="import-code" title="Import the code from a file"><img src="https://img.icons8.com/?size=100&id=RljciFZGONCD&format=png" class="sidebar-img"> <span>Import Code</span></button>

        </div>
      </aside>



      <div class="title">SIMpliCode</div>

      <div class="bottom-section">
        <div class="chat-container" id="chatContainer">
          <div id="conversation-container">
            <div id="conversation"></div>
          </div>
          <textarea id="input" placeholder="Ask SIMpliCode..."></textarea>
          <span>
            <button class="chat-button-left" id="attach" title="Attach a File"><img src="https://img.icons8.com/50/attach" class="chat-img"></button></button>
          <button class="chat-button-right" id="send" title="Send Message"><img src="https://img.icons8.com/50/up" class="chat-img"></button>
          </span>
      </div>

      <div class="divider-horizontal" id="horizontalDivider"></div>

      <div class="editor-container" id="editorContainer">
        <nav class="actions"><button title="Find"><img src="https://img.icons8.com/ios-filled/search"></button><button title="Replace"><img src="https://img.icons8.com/ios-filled/swap"></button><button title="Comment"><img src="https://img.icons8.com/?size=100&id=37966&format=png"></button><button title="Undo" onclick="codeMirror.undo()"><img src="https://img.icons8.com/ios-filled/undo"></button><button title="Redo" onclick="codeMirror.redo()"><img src="https://img.icons8.com/ios-filled/redo"></button><button title="Automatically indent everything perfectly" onclick='codeMirror.execCommand("selectAll"); codeMirror.execCommand("indentAuto"); codeMirror.setSelection(codeMirror.getCursor());'><img src="https://img.icons8.com/?size=100&id=8068&format=png"></button>


          <span id="cursor-pos" class="code-count"></span><span class="code-count">|</span><span id="chr-count" class="code-count"></span><span class="code-count">โข</span><span id="line-num" class="code-count">289 lines</span></nav>

        <navbar><button>index.html</button><button>style.css</button><button style="float: right;">+</button></navbar>
        <textarea id="codespace"></textarea>
      </div>
    </div>

    <div class="divider-vertical" id="verticalDivider"></div>

    <nav class="tab">
      <span>
        <img id="favicon-img"><span id="preview-title">No Title</span>
      </span>
      <button title="Reload Preview" onclick="reloadPreview()">
        <!--<img src="https://img.icons8.com/?size=100&id=90922&format=png&color=222222">-->
        <img src="https://img.icons8.com/?size=100&id=12494&format=png&color=222222">
      </button>
      <button onclick="document.getElementById('fill').requestFullscreen()">
        <img src="https://img.icons8.com/?size=80&id=aZytKIbf5DGB&format=png">
      </button>
    </nav>
    <iframe srcdoc="" id="fill" class="preview-container"></iframe>



    <footer class="copyright" title="Copyright &copy; 2025 Sim3-14159. Icons by Icons8.">
      Copyright &copy; 2025 Sim3-14159. Icons by Icons8.
    </footer>
    </div>

  <div id="popup" class="popup-overlay">
    <div class="popup-content">
      <h2>Download As</h2>
      <input type="text" id="popup-input" placeholder="Enter a filename..." value="SIMpliCode.html" onclick="this.select();"><br><br>
      <button onclick="closePopup()" class="fineButton">Cancel</button>
      <button onclick="downloadCode()" class="goodButton">Download</button>
      <p id="notificationMessage"></p>
    </div>
  </div>

  <script>
    const systemPromptDefault = `You are the **SIMpliCode AI**. You are a helpful HTML, CSS, and JavaScript coding assistant. You always give concise, well thought out answers. Any time you give code, you put it into a code block with a backtick (\`) or triple backtick (\`\`\`), and respond to the user. Never show the raw HTML, CSS, or JavaScript outside of a code block. If the user asks a question like "Can you do this?", then do not just give a generic answer like "Yes", but actually do the thing that they ask. Format your responses richly.`;

    // Function to show thinking animation
    function showThinkingMessage() {
      const conversation = document.getElementById('conversation');
      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'thinking-message';
      thinkingDiv.innerHTML = `
      <span>AI is thinking</span>
      <div class="thinking-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      `;
      thinkingDiv.id = 'thinking-indicator';
      conversation.appendChild(thinkingDiv);
      conversation.parentElement.scrollTop = conversation.parentElement.scrollHeight;
      return thinkingDiv;
    }

    // Function to remove thinking animation
    function removeThinkingMessage() {
      const thinkingIndicator = document.getElementById('thinking-indicator');
      if (thinkingIndicator) {
        thinkingIndicator.remove();
      }
    }

    async function sendToAI(userMessage, currentCode) {
      const responseDiv = document.getElementById('conversation');
      const combinedPrompt = `System: ${systemPromptDefault}\nCurrent code:\n${currentCode}\nUser: ${userMessage}`;

      try {
        const res = await fetch("https://apifreellm.com/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: combinedPrompt })
        });

        if (!res.ok) throw new Error(`HTTP error ${res.status}`);

        const data = await res.json();
        removeThinkingMessage();

        const p = document.createElement('p');
        p.className = 'bot-message';

        if (data.response && data.response.includes('429')) {
          p.innerHTML = "Uh oh, it looks like you've reached your current limit. Please try again later.";
        } else {
          const html = marked.parse(data.response); // todo: sanitize with DOMPurify
          p.innerHTML = html;
        }

        // Highlight code blocks
        p.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });

        responseDiv.appendChild(p);
        responseDiv.parentElement.scrollTop = responseDiv.parentElement.scrollHeight;

      } catch (err) {
        removeThinkingMessage();
        const p = document.createElement('p');
        p.className = 'bot-message';
        p.innerHTML = `<div style="color: red;">Error: ${err.message || 'Something went wrong'}</div>`;
        responseDiv.appendChild(p);
        responseDiv.parentElement.scrollTop = responseDiv.parentElement.scrollHeight;
      }
    }

    // --- REPLACE WizardOrpheus sendMessage calls ---
    document.getElementById('input').addEventListener('keyup', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        let userInput = this.value.trim();
        if (!userInput) return;

        const currentCode = codeMirror.getValue();
        showThinkingMessage();
        sendToAI(userInput, currentCode);

        const conversation = document.getElementById('conversation');
        const pUser = document.createElement('p');
        pUser.className = 'user-message';
        pUser.textContent = userInput;
        conversation.appendChild(pUser);
        conversation.parentElement.scrollTop = conversation.parentElement.scrollHeight;
        this.value = '';
      }
    });

    document.getElementById('send').addEventListener('click', () => {
      const input = document.getElementById('input');
      const userInput = input.value.trim();
      if (!userInput) return;

      showThinkingMessage();
      sendToAI(userInput, codeMirror.getValue());

      const conversation = document.getElementById('conversation');
      const pUser = document.createElement('p');
      pUser.className = 'user-message';
      pUser.textContent = userInput;
      conversation.appendChild(pUser);
      conversation.parentElement.scrollTop = conversation.parentElement.scrollHeight;
      input.value = '';
    });

    // --- ORIGINAL SCRIPT BELOW (unchanged) ---

    // Resizable functionality - improved and fixed
    let isResizingHorizontal = false;
    let isResizingVertical = false;

    const horizontalDivider = document.getElementById('horizontalDivider');
    const verticalDivider = document.getElementById('verticalDivider');
    const chatContainer = document.getElementById('chatContainer');
    const editorContainer = document.getElementById('editorContainer');
    const bottomSection = document.querySelector('.bottom-section');
    const previewContainer = document.getElementById('fill');

    horizontalDivider.addEventListener('mousedown', (e) => {
      isResizingHorizontal = true;
      document.body.style.cursor = 'col-resize';
      e.preventDefault();
    });

    verticalDivider.addEventListener('mousedown', (e) => {
      isResizingVertical = true;
      document.body.style.cursor = 'row-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizingHorizontal && !isResizingVertical) return;

      if (isResizingHorizontal) {
        const containerRect = bottomSection.getBoundingClientRect();
        const containerLeft = containerRect.left;
        const containerWidth = containerRect.width;

        const mouseX = e.clientX;
        const relativeX = mouseX - containerLeft;

        let chatPercentage = (relativeX / containerWidth) * 100;
        chatPercentage = Math.max(25, Math.min(75, chatPercentage));

        chatContainer.style.flex = `0 0 ${chatPercentage}%`; 
        editorContainer.style.flex = `0 0 ${96.8 - chatPercentage}%`;
      } 

      if (isResizingVertical) {
        const containerRect = document.querySelector('.main-container').getBoundingClientRect();
        const titleHeight = document.querySelector('.title').offsetHeight + 40;

        const totalHeight = window.innerHeight - titleHeight - 20;
        const mouseY = e.clientY - titleHeight - 20;

        let bottomPercentage = (mouseY / totalHeight) * 100;
        bottomPercentage = Math.max(25, Math.min(75, bottomPercentage));

        bottomSection.style.height = `${bottomPercentage}vh`;
        previewContainer.style.height = `${100 - bottomPercentage}vh`;
      }
    });

    document.addEventListener('mouseup', () => {
      isResizingHorizontal = false;
      isResizingVertical = false;
      document.body.style.cursor = 'default';
    });

    document.addEventListener('mouseleave', () => {
      isResizingHorizontal = false;
      isResizingVertical = false;
      document.body.style.cursor = 'default';
    });

    // Initialize CodeMirror
    const codeMirror = CodeMirror.fromTextArea(document.getElementById('codespace'), {
      lineNumbers: true,
      mode: 'htmlmixed',
      theme: 'monokai',
      lineWrapping: true,
      autoCloseTags: true,
      autoCloseBrackets: true,
      matchBrackets: true,
      indentUnit: 2,
      tabSize: 2,
      indentWithTabs: false,
      viewportMargin: Infinity,
      smartIndent: true
    });

    codeMirror.on("cursorActivity", function(instance) {
      const cursor = instance.doc.getCursor();
      document.getElementById("cursor-pos").textContent = (cursor.line + 1) + ":" + cursor.ch;
    });

    codeMirror.on('change', function(cm) { 
      const lineCount = cm.lineCount();
      const newHeight = Math.max(300, lineCount * 24 + 50);
      cm.setSize(null, (newHeight - 110) + 'px');

      const code = cm.getValue();
      const iframe = document.getElementById("fill");
      iframe.srcdoc = code;
      document.getElementById("chr-count").textContent = code.length + " chr";
      document.getElementById("chr-count").title = code.length + " characters";
      document.getElementById("line-num").textContent = lineCount + " ln";
      document.getElementById("line-num").title = lineCount + " lines";

      iframe.onload = () => {
        const iframeTitle = iframe.contentDocument.title || 'No Title';
        document.getElementById("preview-title").textContent = iframeTitle;

        const doc = iframe.contentDocument;
        const iconLink = doc.querySelector('link[rel~="icon"]');

        let faviconUrl;

        if (iconLink) {
          faviconUrl = new URL(iconLink.getAttribute('href'), doc.baseURI).href;
        } else {
          faviconUrl = new URL('./favicon.ico', doc.baseURI).href;
        }

        document.getElementById("favicon-img").src = faviconUrl;
      };

      saveData();
    });

    loadData();

    const toggleBtn = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');

    let rotation = 0;

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('open');

      rotation += 360;
      toggleBtn.style.transform = `rotate(${rotation}deg)`;
    });

    function openPopup() {
      document.getElementById("popup").style.display = "flex";
      document.getElementById("popup-input").value = localStorage.getItem("last-download-file-name") || "SIMpliCode.html";
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
      document.getElementById("popup-input").value = "";
      document.getElementById("notificationMessage").textContent = "";
    }

    function downloadCode() {
      const text = codeMirror.getValue().trim();
      if (!text) {
        alert("Empty code!");
        return;
      }

      const blob = new Blob([text], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const inputArea = document.getElementById("popup-input");
      a.href = url;
      a.download = inputArea.value;
      a.click();
      URL.revokeObjectURL(url);
      localStorage.setItem("last-download-file-name", inputArea.value);
      closePopup();
    }

    function downloadChat() {
      const conversation = document.getElementById('conversation');
      const messages = conversation.querySelectorAll('p');

      let rtfContent = `{\\rtf1\\ansi\\deff0\n`;

      messages.forEach((msg) => {
        if (msg.classList.contains('user-message')) {
          rtfContent += `\\b You said:\\b0\\line\n${escapeRtf(msg.textContent.trim())}\\line\\line\n`;
        } else if (msg.classList.contains('bot-message')) {
          rtfContent += `\\b SIMpliCode said:\\b0\\line\n${escapeRtf(msg.textContent.trim())}\\line\\line\n`;
        } else if (msg.classList.contains('win-message')) {
          rtfContent += `\\b System Message:\\b0\\line\n${escapeRtf(msg.textContent.trim())}\\line\\line\n`;
        }
      });

      rtfContent += `}`;

      if (rtfContent === '{\\rtf1\\ansi\\deff0\n}') {
        alert("There is nothing in the chat!");
        return;
      }

      const blob = new Blob([rtfContent], { type: 'application/rtf' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'SIMpleChat.rtf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function escapeRtf(text) {
      let rtf = '';

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const code = char.charCodeAt(0);

        if (char === '\\') {
          rtf += '\\\\';
        } else if (char === '{') {
          rtf += '\\{';
        } else if (char === '}') {
          rtf += '\\}';
        } else if (code > 127) {
          rtf += `\\u${code}?`;
        } else if (char === '\n') {
          rtf += '\\line\n';
        } else {
          rtf += char;
        }
      }

      return rtf;
    }

    function saveData() {
      const input = codeMirror.getValue();
      localStorage.setItem('myData', input);
    }

    function loadData() {
      const storedData = localStorage.getItem('myData');
      codeMirror.setValue(storedData ? storedData : `<!--Welcome to the codespace! Write your code here and the AI will be able to help you with it! This is some example HTML to get you started.-->
<!DOCTYPE html>
<html lang='en'>
<meta charset="UTF-8">
  <head>
    <title>Basic Example</title>
    <style>
      /* Put your styles here. */
    </style>
    </head>
  <body>
    <h1>Basic Example</h1>
    <p>This is a paragraph of words in the basic example</p>
      <script>
        /*Any JavaScript you create will go here*/
    </s\cript>
    </body>
    </html>`);
    }

    function reloadPreview() {
      previewContainer.srcdoc = codeMirror.getValue();
    }
</script>
  </body>
</html>
